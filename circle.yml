machine:
  services:
  - docker
  pre:
  - echo 'DOCKER_OPTS="-s btrfs -e lxc -D --userland-proxy=false"' | sudo tee -a /etc/default/docker
  - sudo curl -L -o /usr/bin/docker 'https://s3-external-1.amazonaws.com/circle-downloads/docker-1.8.2-circleci-cp-workaround'
  - sudo chmod 0755 /usr/bin/docker
  post:
  environment:
    CHECKOUT: $HOME/$CIRCLE_PROJECT_REPONAME
    BASE_DIR: src/github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME
checkout:
  post:
  - git submodule sync
  - git submodule update --init
dependencies:
  override:
  - docker login -u "$DOCKER_HUB_USERNAME" -p "$DOCKER_HUB_PASSWORD" -e "$DOCKER_HUB_EMAIL"
test:
  pre:
  override:
  - make fmt NO_EXEC=true
  - make build-integration NO_EXEC=true
  - make test-ginkgo TESTFLAGS='-race ./pkg/jobrunner-framework' NO_EXEC=true
  - make test NO_EXEC=true RUN_COVERAGE=true
  - make api-docs NO_EXEC=true
  post:
  - mkdir -p $CIRCLE_ARTIFACTS/apidocs
  - cp -r apidocgen/output/* $CIRCLE_ARTIFACTS/apidocs
  - cp test-coverage.txt coverage.xml $CIRCLE_ARTIFACTS/
  - bash <(curl -s https://codecov.io/bash) -t "$CODECOV_TOKEN"
