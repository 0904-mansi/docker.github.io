<html>
    <head>
        <title>Docker Datacenter Auth</title>
        <!-- It's okay if this is not reachable, fonts may just look bad. -->
        <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
        <style>
            body {
                color: white;
                text-align: center;
                font-style: normal;
                font-variant: normal;
                font-weight: normal;
                font-size: 14px;
                font-height: 20px;
                font-family: 'Open Sans';
                -webkit-font-smoothing: antialiased;
            }

            ::-webkit-input-placeholder {
                opacity: 0.4;
                color: #ededed;
            }

            :-moz-placeholder { /* Firefox 18- */
                opacity: 0.4;
                color: #ededed;
            }

            ::-moz-placeholder {  /* Firefox 19+ */
                opacity: 0.4;
                color: #ededed;
            }

            :-ms-input-placeholder {  
                opacity: 0.4;
                color: #ededed;
            }

            #content {
                max-width: 320px;
                margin: 0px auto;
                padding: 120px 0;
            }

            #header {
                font-weight: bold;
                font-size: 20px;
                font-height: 26.6px;
                margin-top: 25px;
            }

            #login_form {
                margin-top: 30px;
                width: 320px;
            }

            .form_text_input {
                color: rgba(255, 255, 255, 0.9);
                width: 100%;
                text-align: left;
                background: #1aaaf8;
                border: 0px;
                border-bottom: 2px solid rgba(255, 255, 255, 0.7);
                font-size: 14px;
                font-height: 17px;
                outline: unset;
                padding: 10px 14px;
                margin-bottom: 14px;
            }

            .form_submit_button {
                color: #1aaaf8;
                text-decoration: inherit;
                background-color: white;
                border: 0px;
                border-radius: 2px;
                font: normal normal bold normal 14px / 14px 'Open Sans';
                padding: 12px 22px;
                margin-top: 14px;
                cursor: pointer;
                display: inline-block;
            }

            .form_submit_button:hover {
                opacity: 0.9;
            }

            .form_submit_button:focus {
                outline-color: white;
            }
        </style>
        <script src="{{.JQuerySource}}"></script>
        <script type="text/javascript">
            $(document).ready(function() {
                console.log("loading");

                // Wrap the localStorage API with helper functions which save
                // values as JSON. This lets us store objects and numbers in
                // localStorage and not just Strings.
                var storage = {
                    get: function(key) {
                        var jsonValue = window.localStorage.getItem(key);
                        if (jsonValue === undefined || jsonValue === null) {
                            return undefined;
                        }
                        return JSON.parse(jsonValue);
                    },
                    set: function(key, value) {
                        var jsonValue = JSON.stringify(value);
                        if (jsonValue === undefined) {
                            return undefined;
                        }
                        window.localStorage.setItem(key, jsonValue);
                    },
                    remove: function(key) {
                        window.localStorage.removeItem(key);
                    },
                };

                var getQueryVariable = function(variable) {
                    var query = window.location.search.substring(1);
                    var vars = query.split('&');
                    for (var i = 0; i < vars.length; i++) {
                        var pair = vars[i].split('=');
                        if (decodeURIComponent(pair[0]) == variable) {
                            return decodeURIComponent(pair[1]);
                        }
                    }
                    return "";
                };

                var defaultRedirectLocation = "{{.DefaultRedirectLocation}}";

                var loginContent = '\
                    <div id="content">\
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNDMiIHZpZXdCb3g9IjAgMCA2MCA0MyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48dGl0bGU+bG9nbyBjb3B5PC90aXRsZT48ZyBmaWxsPSIjRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0zLjc1NyAxNS43NjhoNi4wNHY1Ljg3M2gtNi4wNFYxNS43N3pNMTEuMTcgMTUuNzY4aDYuMDR2NS44NzNoLTYuMDRWMTUuNzd6TTExLjE3IDguMjRoNi4wNHY1Ljg3aC02LjA0VjguMjR6TTE4LjU4IDE1Ljc2OGg2LjA0M3Y1Ljg3M0gxOC41OFYxNS43N3pNMTguNTggOC4yNGg2LjA0M3Y1Ljg3SDE4LjU4VjguMjR6TTI1Ljk5MyAxNS43NjhoNi4wNDJ2NS44NzNoLTYuMDQyVjE1Ljc3ek0yNS45OTMgOC4yNGg2LjA0MnY1Ljg3aC02LjA0MlY4LjI0ek0zMy40MDUgMTUuNzY4aDYuMDQydjUuODczaC02LjA0MlYxNS43N3pNMjUuOTkzLjcwOGg2LjA0MlY2LjU4aC02LjA0MlYuNzA4ek0xMi4xOTQgMzAuMTJjLS45MyAwLTEuNjg0LjczMy0xLjY4NCAxLjYzNiAwIC45MDIuNzU1IDEuNjM1IDEuNjg0IDEuNjM1LjkyOCAwIDEuNjgzLS43MzIgMS42ODMtMS42MzQgMC0uOTAzLS43NTUtMS42MzctMS42ODMtMS42MzciLz48cGF0aCBkPSJNNTguOTA1IDE4LjgwNmMtMi4wMy0xLjEzOC00LjczLTEuMjk0LTcuMDMtLjYzNi0uMjgzLTIuMzc3LTEuODktNC40Ni0zLjgtNS45NTNsLS43NTgtLjU5My0uNjM4LjcxNmMtMS4yOCAxLjQzOC0xLjY2IDMuODMtMS40ODcgNS42NjYuMTMgMS4zNS41NjUgMi43MjIgMS40MiAzLjgwNi0uNjUuMzgtMS4zODguNjgyLTIuMDQ1LjktMS4zNC40NC0yLjc5NS42ODUtNC4yMS42ODVILjYxM2wtLjA4NS44OWMtLjI4NSAyLjk3Mi4xMzQgNS45NDcgMS4zOTggOC42NmwuNTQ0IDEuMDc4LjA2Mi4xYzMuNzM3IDYuMTcgMTAuMyA4Ljc2OCAxNy40NTIgOC43NjggMTMuODQ2IDAgMjUuMjY1LTYuMDEgMzAuNTEtMTguNzA4IDMuNTA1LjE3OCA3LjA5LS44MyA4LjgwNS00LjA4M2wuNDM3LS44My0uODMyLS40NjZ6bS00Ni43MSAxNi4wNTZjLTEuNzY0IDAtMy4xOTgtMS4zOTQtMy4xOTgtMy4xMDYgMC0xLjcxMyAxLjQzNC0zLjEwNyAzLjE5Ny0zLjEwNyAxLjc2MyAwIDMuMTk3IDEuMzkzIDMuMTk3IDMuMTA2IDAgMS43MTItMS40MzMgMy4xMDYtMy4xOTYgMy4xMDZ6Ii8+PC9nPjwvc3ZnPg==" alt="" />\
                        <h1 id="header">\
                            Docker Datacenter\
                        </h1>\
                        <p id="welcome">\
                            Welcome! Please login to your account.\
                        </p>\
                        <div id="messages"></div>\
                        <form id="login_form">\
                            <input id="username" placeholder="Username" class="form_text_input" />\
                            <input id="password" type="password" placeholder="Password"  class="form_text_input" />\
                            <button id="submit_button" href="#" class="form_submit_button">Login</button>\
                        </form>\
                    </div>\
                ';

                var logoutContent = '\
                    <div id="content">\
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNDMiIHZpZXdCb3g9IjAgMCA2MCA0MyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48dGl0bGU+bG9nbyBjb3B5PC90aXRsZT48ZyBmaWxsPSIjRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0zLjc1NyAxNS43NjhoNi4wNHY1Ljg3M2gtNi4wNFYxNS43N3pNMTEuMTcgMTUuNzY4aDYuMDR2NS44NzNoLTYuMDRWMTUuNzd6TTExLjE3IDguMjRoNi4wNHY1Ljg3aC02LjA0VjguMjR6TTE4LjU4IDE1Ljc2OGg2LjA0M3Y1Ljg3M0gxOC41OFYxNS43N3pNMTguNTggOC4yNGg2LjA0M3Y1Ljg3SDE4LjU4VjguMjR6TTI1Ljk5MyAxNS43NjhoNi4wNDJ2NS44NzNoLTYuMDQyVjE1Ljc3ek0yNS45OTMgOC4yNGg2LjA0MnY1Ljg3aC02LjA0MlY4LjI0ek0zMy40MDUgMTUuNzY4aDYuMDQydjUuODczaC02LjA0MlYxNS43N3pNMjUuOTkzLjcwOGg2LjA0MlY2LjU4aC02LjA0MlYuNzA4ek0xMi4xOTQgMzAuMTJjLS45MyAwLTEuNjg0LjczMy0xLjY4NCAxLjYzNiAwIC45MDIuNzU1IDEuNjM1IDEuNjg0IDEuNjM1LjkyOCAwIDEuNjgzLS43MzIgMS42ODMtMS42MzQgMC0uOTAzLS43NTUtMS42MzctMS42ODMtMS42MzciLz48cGF0aCBkPSJNNTguOTA1IDE4LjgwNmMtMi4wMy0xLjEzOC00LjczLTEuMjk0LTcuMDMtLjYzNi0uMjgzLTIuMzc3LTEuODktNC40Ni0zLjgtNS45NTNsLS43NTgtLjU5My0uNjM4LjcxNmMtMS4yOCAxLjQzOC0xLjY2IDMuODMtMS40ODcgNS42NjYuMTMgMS4zNS41NjUgMi43MjIgMS40MiAzLjgwNi0uNjUuMzgtMS4zODguNjgyLTIuMDQ1LjktMS4zNC40NC0yLjc5NS42ODUtNC4yMS42ODVILjYxM2wtLjA4NS44OWMtLjI4NSAyLjk3Mi4xMzQgNS45NDcgMS4zOTggOC42NmwuNTQ0IDEuMDc4LjA2Mi4xYzMuNzM3IDYuMTcgMTAuMyA4Ljc2OCAxNy40NTIgOC43NjggMTMuODQ2IDAgMjUuMjY1LTYuMDEgMzAuNTEtMTguNzA4IDMuNTA1LjE3OCA3LjA5LS44MyA4LjgwNS00LjA4M2wuNDM3LS44My0uODMyLS40NjZ6bS00Ni43MSAxNi4wNTZjLTEuNzY0IDAtMy4xOTgtMS4zOTQtMy4xOTgtMy4xMDYgMC0xLjcxMyAxLjQzNC0zLjEwNyAzLjE5Ny0zLjEwNyAxLjc2MyAwIDMuMTk3IDEuMzkzIDMuMTk3IDMuMTA2IDAgMS43MTItMS40MzMgMy4xMDYtMy4xOTYgMy4xMDZ6Ii8+PC9nPjwvc3ZnPg==" alt="" />\
                        <h1 id="header">\
                            Docker Datacenter\
                        </h1>\
                        <p id="welcome">\
                            Click \'Logout\' to securely end your session.\
                        </p>\
                        <form id="logout_form">\
                            <button id="submit_button" href="#" class="form_submit_button">Logout</button>\
                        </form>\
                    </div>\
                ';

                var loginHandler = function() {
                    if (storage.get("sessionToken")) {
                        redirect();
                        return;
                    }

                    renderBody(loginContent);

                    $("#submit_button").click(function(event) {
                        if (storage.get("sessionToken")) {
                            // Do not submit form if the user has already
                            // logged in in another window/tab.
                            redirect();
                            return;
                        }

                        var username = $("#username").val();
                        var password = $("#password").val();
                        $.ajax({
                            method: "POST",
                            url: "{{.LoginEndpoint}}",
                            contentType: "application/json",
                            dataType: "json",
                            data: JSON.stringify({
                                username: username,
                                password: password
                            }),
                        }).done(function(data, textStatus, jqXHR) {
                            storage.set("sessionToken", data.sessionToken);
                            var next = getQueryVariable("next");
                            if (!next) {
                                next = defaultRedirectLocation;
                            }
                            window.location.replace(next);
                        }).fail(function(jqXHR, textStatus, errorThrown) {
                            console.log({
                                jqXHR: jqXHR,
                                textStatus: textStatus,
                                errorThrown: errorThrown
                            });
                            var errData = JSON.parse(jqXHR.responseText);
                            $.each(errData.errors, function(i, error) {
                                console.log(error);
                                if (error.code == "INVALID_FORM_FIELD") {
                                    var message = $("<p>").text(error.detail.reason).css("color", "rgba(255, 0, 0, 0.8)");
                                    $("#messages").append(message);
                                }
                            });
                        });

                        $("#messages").empty();

                        return false;
                    });

                    $("#submit_button").keypress(function (e) {
                        if(e.which == 32) {
                            // Pressed the spacebar.
                            $("#submit_button").click();  
                        }

                        return false;
                    });
                };

                var logoutHandler = function() {
                    // Redirect to Login page if next is not specified.
                    defaultRedirectLocation = (getQueryVariable("next") || "{{.LoginPage}}");

                    if (!storage.get("sessionToken")) {
                        redirect();
                        return;
                    }

                    renderBody(logoutContent);

                    $("#submit_button").click(function(event) {
                        var sessionToken = storage.get("sessionToken");
                        if (!sessionToken) {
                            // Do not submit form if the user has already
                            // logged out in another window/tab.
                            redirect();
                            return;
                        }

                        $.ajax({
                            method: "POST",
                            url: "{{.LogoutEndpoint}}",
                            headers: {
                                "Authorization": "SessionToken " + sessionToken
                            },
                        }).fail(function(jqXHR, textStatus, errorThrown) {
                            console.log({
                                jqXHR: jqXHR,
                                textStatus: textStatus,
                                errorThrown: errorThrown
                            });
                            var errData = JSON.parse(jqXHR.responseText);
                            $.each(errData.errors, function(i, error) {
                                console.log(error);
                            });
                        }).always(function() {
                            storage.remove("sessionToken");
                            redirect();
                        });

                        return false;
                    });

                    $("#submit_button").keypress(function (e) {
                        if(e.which == 32) {
                            // Pressed the spacebar.
                            $("#submit_button").click();  
                        }

                        return false;
                    });
                };

                var authorizeHandler = function() {
                    var sessionToken = storage.get("sessionToken");
                    // Require authentication.
                    if (!sessionToken) {
                        var params = $.param({next: window.location.toString()})
                        redirect("{{.LoginPage}}?" + params);
                        return;
                    }

                    // Prepare the authorization post request.
                    var params = {
                        scope:         getQueryVariable("scope"),
                        response_type: getQueryVariable("response_type"),
                        client_id:     getQueryVariable("client_id"),
                        redirect_uri:  getQueryVariable("redirect_uri"),
                        state:         getQueryVariable("state")
                    }

                    $.ajax({
                        method: "POST",
                        url: "{{.AuthorizeEndpoint}}",
                        dataType: "json",
                        headers: {
                            "Authorization": "SessionToken " + sessionToken
                        },
                        data: params,
                    }).done(function(data, textStatus, jqXHR) {
                        window.location.replace(data.redirect);
                    }).fail(function(jqXHR, textStatus, errorThrown) {
                        console.log({
                            jqXHR: jqXHR,
                            textStatus: textStatus,
                            errorThrown: errorThrown
                        });

                        if (jqXHR.status == 401) {
                            // The session token must be bad.
                            storage.remove("sessionToken");

                            var params = $.param({next: window.location.toString()})

                            redirect("{{.LoginPage}}?" + params);
                            return;
                        }

                        var errData = JSON.parse(jqXHR.responseText);
                        $.each(errData.errors, function(i, error) {
                            console.log(error);
                        });
                    });
                };

                var redirect = function(where) {
                    if (!where) {
                        where = (next = getQueryVariable("next")) ? next : defaultRedirectLocation;
                    }
                    window.location.replace(where);
                };

                var renderBody = function(htmlContent) {
                    var body = $("body");
                    body.css({background: "#1aaaf8"});
                    body.html(htmlContent);
                };

                switch (window.location.pathname) {
                    case "{{.LoginPage}}":
                        loginHandler();
                        break;
                    case "{{.LogoutPage}}":
                        logoutHandler();
                        break;
                    case "{{.AuthorizePage}}":
                        authorizeHandler();
                        break;
                    default:
                        redirect();
                }
            });
        </script>
    </head>
    <body></body>
</html>
